(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[7587],{8608:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"Floorplans"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"floorplans"},arguments:[{kind:"Argument",name:{kind:"Name",value:"provider"},value:{kind:"StringValue",value:"Matterport",block:!1}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"status"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"height"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"width"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"resolution"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"origin"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"flags"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"provider"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:402}};t.loc.source={body:'query Floorplans($modelId: ID!) {\n  model(id: $modelId) {\n    id\n    assets {\n      floorplans(provider: "Matterport") {\n        id\n        status\n        url\n        validUntil\n        filename\n        format\n        height\n        width,\n        resolution,\n        origin {\n          x,\n          y\n        }\n        floor {\n          id\n        }\n        flags\n        provider\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function a(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.Floorplans=function(e,t){var i={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var o=n[t]||new Set,s=new Set,r=new Set;for(o.forEach((function(e){r.add(e)}));r.size>0;){var l=r;r=new Set,l.forEach((function(e){s.has(e)||(s.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return s.forEach((function(t){var n=a(e,t);n&&i.definitions.push(n)})),i}(t,"Floorplans")},46672:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"ImportAutoGallery"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"importAutoGallery"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[]}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"StartAutoGalleryImport"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"startAutoGalleryImport"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[]}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetAutoGalleryImportWorkflow"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"workflowId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"autoGalleryImportWorkflow"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"workflowId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"modelId"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"state"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:319}};t.loc.source={body:"mutation ImportAutoGallery($modelId: ID!) {\n  importAutoGallery(modelId: $modelId)\n}\n\nmutation StartAutoGalleryImport($modelId: ID!) {\n  startAutoGalleryImport(modelId: $modelId)\n}\n\nquery GetAutoGalleryImportWorkflow($workflowId: ID!) {\n  autoGalleryImportWorkflow(id: $workflowId) {\n    modelId\n    id\n    state\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function a(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function o(e,t){var i={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var o=n[t]||new Set,s=new Set,r=new Set;for(o.forEach((function(e){r.add(e)}));r.size>0;){var l=r;r=new Set,l.forEach((function(e){s.has(e)||(s.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return s.forEach((function(t){var n=a(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.ImportAutoGallery=o(t,"ImportAutoGallery"),e.exports.StartAutoGalleryImport=o(t,"StartAutoGalleryImport"),e.exports.GetAutoGalleryImportWorkflow=o(t,"GetAutoGalleryImportWorkflow")},35159:(e,t,i)=>{"use strict";var n;i.d(t,{_:()=>n}),function(e){e.CAPTURING="capturing",e.UPLOADING="uploading",e.ERROR="error",e.DONE="done"}(n||(n={}))},86426:(e,t,i)=>{"use strict";i.d(t,{Ns:()=>s,gp:()=>a,t6:()=>r,tZ:()=>o});var n=i(55141);class a extends n.u{constructor(e,t){super(),this.payload={id:e,name:t}}}a.id="RENAME_SNAPSHOT";class o extends n.u{constructor(e){super(),this.payload={id:e}}}o.id="DELETE_SNAPSHOT";class s extends n.u{constructor(e){super(),this.payload={snapshot:e}}}s.id="UPLOAD_SNAPSHOT";class r extends n.u{constructor(e){super(),this.payload={id:e}}}r.id="SET_CURRENT_SNAPSHOT_PHOTO"},47067:(e,t,i)=>{"use strict";i.d(t,{P:()=>o});var n=i(12554),a=i(85616);class o extends a.v{constructor(e){super(),this.reel=(0,n.Z)([]),this.modified=new Date,this.mode=e,this.commit()}replace(e){this.atomic((()=>{this.sid=e.sid,this.reel.replace(Array.from(e.reel.values())),this.mode=e.mode,this.modified=e.modified}))}copy(e){return this.atomic((()=>{this.sid=e.sid,this.mode=e.mode,this.modified=e.modified,this.reel=(0,n.Z)([...e.reel.map((e=>Object.assign({},e)))])})),this}clone(){return new o(this.mode).copy(this)}}},37e3:(e,t,i)=>{"use strict";i.d(t,{Wu:()=>f});var n=i(10843),a=i(13893),o=i(1333),s=i(25481),r=i(44094),l=i(74381),d=i(72853),u=i(57186),c=i(93877);const m=new n.Ay("mds-reel-element-serializer"),h={[l.ES.FADE_TO_BLACK]:a.fl.FadeToBlack,[l.ES.INSTANT]:a.fl.Instant,[l.ES.INTERPOLATE]:a.fl.Interpolate},p={[l.Zw.LEFT]:o.ND.Left,[l.Zw.RIGHT]:o.ND.Right,[l.Zw.AUTO]:o.ND.Auto};class f{constructor(e){this.sweepTagRequirements=e,this.assetDeserializer=new d.S,this.viewDeserailizer=new u.K}deserialize(e){var t;if(!e||!(null===(t=null==e?void 0:e.asset)||void 0===t?void 0:t.id))return m.debug("Deserialized invalid highlight reel entry from MDS",e),null;const i=e.overrides,n={},a=(null==i?void 0:i.transitionType)?h[null==i?void 0:i.transitionType]:void 0,o=(null==i?void 0:i.panDirection)?p[null==i?void 0:i.panDirection]:void 0,l=null==i?void 0:i.panAngle;(0,r.s)(a)&&(n.transitionType=a),(0,r.s)(o)&&(n.panDirection=o),(0,s.Et)(l)&&(n.panAngle=l);const d=this.assetDeserializer.deserialize(e.asset),u=null==d?void 0:d.metadata.scanTags,f=!this.sweepTagRequirements||!u||u.includes(this.sweepTagRequirements);if(!d||!f)return null;let v;const g=this.viewDeserailizer.getModelViewType(e.sourceView);g!==c.jK.DEFURNISH&&g!==c.jK.DIGIPRO_SESSION||(v=e.sourceView.id),d.sourceViewId=v,g===c.jK.INSIGHTS&&(d.sourceViewId=e.sourceView.id,n.panAlignment="center");const w={id:e.asset.id,overrides:n,snapshot:d,sourceViewId:v};return e.title&&(w.title=e.title),e.description&&(w.description=e.description),w}}},61032:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>re});var n=i(65945),a=i(75578),o=i(27947),s=i(22585),r=i(90082),l=i(71687),d=i(28165),u=i(2993),c=i(10843),m=i(73566),h=i(64650),p=i(73094),f=i(95300),v=i(25712),g=i(74381),w=i(13893),y=i(47067),I=i(35447),k=i(93327),D=i(37e3);const S=new c.Ay("get-highlights-for-view"),N=async({modelId:e,viewType:t,client:i})=>{var n,a,o,s,r;const{data:l}=await i.query(k.GetHighlightReelForView,{modelId:e,viewType:t}),d=[],u=new D.Wu(null);return null===(r=null===(s=null===(o=null===(a=null===(n=null==l?void 0:l.model)||void 0===n?void 0:n.view)||void 0===a?void 0:a.model)||void 0===o?void 0:o.activeHighlightReel)||void 0===s?void 0:s.reel)||void 0===r||r.forEach((e=>{const t=u.deserialize(e);t?d.push(t):S.warn("Failed to deserialize reel")})),d};var b=i(52018);class T extends b.t{constructor(e){super(e),this.name="TourGenerationError"}}var A=i(46672);var O=i(29819);const E={[g.Bu.CANCELED]:h.s.CANCELED,[g.Bu.COMPLETED]:h.s.COMPLETED,[g.Bu.CONTINUEDASNEW]:h.s.CONTINUED,[g.Bu.FAILED]:h.s.FAILED,[g.Bu.RUNNING]:h.s.RUNNING,[g.Bu.TERMINATED]:h.s.TERMINATED,[g.Bu.TIMEDOUT]:h.s.TIMEOUT,[g.Bu.UNRECOGNIZED]:h.s.UNKNOWN,[g.Bu.UNSPECIFIED]:h.s.UNKNOWN},R=({workflowId:e,status:t,maxRetries:i=15,client:n})=>(0,O.F)((async()=>{const i=await(async({workflowId:e,client:t})=>{var i,n,a;const{data:o}=await t.query(A.GetAutoGalleryImportWorkflow,{workflowId:e});return(null===(i=null==o?void 0:o.autoGalleryImportWorkflow)||void 0===i?void 0:i.id)&&(null===(n=null==o?void 0:o.autoGalleryImportWorkflow)||void 0===n?void 0:n.modelId)?{id:o.autoGalleryImportWorkflow.id,modelId:o.autoGalleryImportWorkflow.modelId,status:(s=null===(a=null==o?void 0:o.autoGalleryImportWorkflow)||void 0===a?void 0:a.state,s&&E[s]?E[s]:h.s.UNKNOWN)}:null;var s})({workflowId:e,client:n});return(null==i?void 0:i.status)===t?i:void 0}),{maxRetries:i}),M=new c.Ay("import-auto-gallery"),G=async({client:e,modelId:t,generateText:i=!1})=>{if(!i)return(async({modelId:e,client:t})=>{const{data:i}=await t.mutate(A.ImportAutoGallery,{modelId:e});return!!(null==i?void 0:i.importAutoGallery)})({modelId:t,client:e});const n=await(async({modelId:e,client:t})=>{const{data:i}=await t.mutate(A.StartAutoGalleryImport,{modelId:e});return(null==i?void 0:i.startAutoGalleryImport)||void 0})({modelId:t,client:e});if(!n)throw new T("Unable to start workflow");M.debug(`started workflow ${n}`);const{promise:a,elapsed:o}=R({workflowId:n,status:h.s.COMPLETED,client:e}),s=await a;return M.debug(`workflow ${n} completed in ${o()/1e3} seconds`),!!s};var F=i(28404),P=i(68909),U=i(40397),V=i(81662),B=i(2803),j=i(66416),_=i(35159),C=i(38069),x=i(8608),H=i(61430);const L={disable:"upscale",frame:1},z=(e,t={})=>{const i=Object.assign(Object.assign({},L),t),n=new URL(e,window.location.origin);return Object.entries(i).forEach((([e,t])=>{void 0===t?n.searchParams.delete(e):n.searchParams.set(e,String(t))})),n.toString()};var W=i(24241);const q=async(e,t,i)=>{const{floorsData:n,meshBounds:a,client:o}=e,s=a.getTrimmedBounds();let r=(s.max.z-s.min.z)/2;r*=1.6;const l=s.getCenter(new P.Vector3).setY((0,U.xF)(r)),c=(new P.Quaternion).setFromUnitVectors(V.B1.FORWARD,V.B1.DOWN),{width:m,height:h}=d.hd,p=await async function(e,t,i,n,a,o=.2*a){var s,r,l,d,u;const c=new OffscreenCanvas(n,a),m=c.getContext("2d");m&&(m.fillStyle=C.V.BLACK.getHexString(),m.fillRect(0,0,n,a));try{let c=null===(u=null===(d=null===(l=null===(r=null===(s=(await e.query(x.Floorplans,{modelId:t})).data)||void 0===s?void 0:s.model)||void 0===r?void 0:r.assets)||void 0===l?void 0:l.floorplans)||void 0===d?void 0:d.find((e=>{var t,n;return e.flags.includes(H.o9.ALPHA)&&e.flags.includes(H.o9.PHOTOGRAMY)&&(null===(t=e.url)||void 0===t?void 0:t.includes("vr_colorplan"))&&(!i||(null===(n=e.floor)||void 0===n?void 0:n.id)===i)})))||void 0===u?void 0:u.url;if(c){c=z(c,{width:n-2*o,height:a-2*o,fit:"crop",bgColor:"black",pad:"15%"});const e=await fetch(c).then((e=>e.blob()));null==m||m.drawImage(await createImageBitmap(e),o,o)}}catch(e){new W.Ay("getFloorplanImageBlob").error("Error fetching floorplan image",e)}return c.convertToBlob()}(o,t,i,m,h),f=new B.f(URL.createObjectURL(p),null),g=(new F.F).copy({sid:(0,v.hA)(),metadata:{cameraMode:u.N3.Floorplan,cameraPosition:l,cameraQuaternion:c,orthoZoom:r,ssZoom:r,floorId:i,floorVisibility:n.getOrderedValues().map((e=>e.id===i?1:0)),scanTags:null},name:"floorplan",label:"floorplan",is360:!1,category:j.X.TOUR,created:new Date,modified:new Date,visionLabel:"",visionName:"",state:_._.DONE,thumbnailUrl:f,imageUrl:f,downloadUrl:f,imageBlob:p,height:h,width:m});return{id:(0,v.hA)(),snapshot:g,overrides:{transitionType:w.fl.Interpolate}}};var $=i(941),Q=i(90160);const K=[$.mg,$.GC],Z=[$.Cp,$.pl,$.SE];class Y{constructor({roomBoundData:e,sweepData:t,cameraStartModule:i,snapshotsModule:n,floorsData:a,layersData:o,meshBounds:s}){this.name="scout-tour-template",this.allowedEntries=new Set,this.floorsData=a,this.sweepData=t,this.roomBoundData=e,this.cameraStartModule=i,this.snapshotsModule=n,this.layersData=o,this.meshBounds=s}async generateTour(e){var t;const{modelId:i,panAngle:n,panSpeed:a,regenerateText:o,client:s,includeDefurnish:r}=e;let l=await N({modelId:i,viewType:"matterport.user.insights",client:s})||[];(o||X(l))&&(await G({modelId:i,generateText:!0,client:s}),l=await N({modelId:i,viewType:"matterport.user.insights",client:s})||[]);const d={snapshot:{sourceViewId:null===(t=this.layersData.getInsightsView())||void 0===t?void 0:t.id},resizeAspect:f.BE},c=(e=>{const{cameraStartModule:t,snapshotsModule:i}=e;return(e={})=>{const n=t.data.icon;if(!n)return;let a=i.snapshotsData.get(n);if(a){if(e.snapshot&&(a=a.copy(Object.assign(Object.assign({},a),e.snapshot))),e.resizeAspect){const t=(0,f.IX)(a.width,a.height,e.resizeAspect);a.width=t.width,a.height=t.height}return{id:a.sid,snapshot:a}}}})({cameraStartModule:this.cameraStartModule,snapshotsModule:this.snapshotsModule})(d);c&&(l.unshift(c),this.allowedEntries.add(c.id)),l.forEach((e=>{if(e.snapshot.metadata.cameraMode===u.N3.Panorama&&(e.overrides={transitionType:w.fl.Interpolate,panAlignment:"center",panAngle:n,panSpeed:a}),!e.snapshot.metadata.scanId&&e.snapshot.metadata.cameraPosition){const t=this.sweepData.getClosestSweep(e.snapshot.metadata.cameraPosition,!0);t&&(e.snapshot.metadata.scanId=t.id)}}));const m=new y.P(g.UR.STORY);let h=(e=>{const{sweepData:t,roomBoundData:i}=e;return e=>e.reduce(((e,n)=>{var a;const{cameraPosition:o,scanId:s}=n.snapshot.metadata;if(!o||!s)return e;const r=null===(a=t.getSweep(s))||void 0===a?void 0:a.floorId;if(!r)return e;const l=i.findRoomIdForPosition(o,r)||null;return e.push(Object.assign(Object.assign({},n),{floorId:r,roomId:l,sweepId:s})),e}),[])})({sweepData:this.sweepData,roomBoundData:this.roomBoundData})(l);return h=this.prefilter(h),h=this.sort(h),h=this.postfilter(h),this.allowedEntries.clear(),r&&(h=await this.addDefurnishEntries(h)),h=await this.addFinalStop(h,i,s),m.reel.replace(h),m}isEntryAllowed(e){return this.allowedEntries.has(e)}prefilter(e){if(!(null==e?void 0:e.length))return e;return e.filter((e=>{var t;if(this.isEntryAllowed(e.id))return!0;if((0,I.Qx)(e))return!0;const{cameraPosition:i}=e.snapshot.metadata,n=e.roomId;if(!i||!n)return!1;const a=this.sweepData.getSweep(e.sweepId);if(!a.isAligned()||!a.enabled)return!1;const o=this.roomBoundData.getRoom(n);return!K.includes(null===(t=o.classifications[0])||void 0===t?void 0:t.id)}))}postfilter(e){if(!(null==e?void 0:e.length))return e;const t=new Set,i={};let n=null;return e.filter((e=>{var a;if(this.isEntryAllowed(e.id))return!0;if((0,I.Qx)(e))return!0;const{cameraPosition:o}=e.snapshot.metadata,{roomId:s,sweepId:r}=e;if(!o||!s)return!1;if(t.has(r))return!1;const l=this.sweepData.getSweep(r);if(n){if(n.position.distanceTo(l.position)<2)return!1}return!((null===(a=this.roomBoundData.getRoom(s).classifications[0])||void 0===a?void 0:a.id)===$.Cp&&i[s]>=1)&&(!(i[s]>=2)&&(t.add(r),i[s]?i[s]+=1:i[s]=1,n=l,!0))}))}sort(e){if(!(null==e?void 0:e.length))return e;const t=new Set,i=e.reduce(((e,t)=>(e[t.id]=t,e)),{}),n=(e=>{const{sweepData:t}=e;return(e,i)=>{if(!e.snapshot.metadata.scanId||i.length<=1)return i[0];const n=t.getSweep(e.snapshot.metadata.scanId);return i.map((e=>{const i=e.snapshot.metadata.scanId,a=t.getSweep(i);return{highlight:e,distance:n.position.distanceToSquared(a.position)}})).sort(((e,t)=>e.distance-t.distance))[0].highlight}})({sweepData:this.sweepData}),a=e=>{if(!e.floorId)return;const a=Object.values(i).filter((i=>i.floorId===e.floorId&&!t.has(i))),o=this.sweepData.getSweep(e.sweepId).neighbours,s=a.filter((e=>!!e.sweepId&&o.includes(e.sweepId))),r=s.length?s:a;return n(e,r)},o=e=>{const n=Object.values(i).find((i=>i.floorId===e.floorId&&!t.has(i)));if(n)return n;const a=e.floorId?this.floorsData.getFloor(e.floorId):null,o=(null==a?void 0:a.index)||0,s=this.floorsData.getOrderedValues();for(let e=o;e<s.length;e++){const n=s[e],a=Object.values(i).find((e=>e.floorId===n.id&&!t.has(e)));if(a)return a}return Object.values(i).find((e=>!t.has(e)))},s=e=>{t.add(e);const r=(e=>{if(!(null==e?void 0:e.roomId))return;const a=Object.values(i).filter((i=>i.roomId===e.roomId&&!t.has(i)));return a.length>1?n(e,a):a[0]})(e)||a(e)||o(e);r&&s(r)},r=i[e[0].id];s(r);const l=Array.from(t),d=l.find(I.Qx);return d?[d,...l.filter((e=>e.id!==d.id))]:l}async addFinalStop(e,t,i){const n=this.cameraStartModule.data.getStartingPose(),a=this.sweepData.getStartSweep(n)||this.sweepData.getSweep(e[0].sweepId),o=this.floorsData.getFloorCount()>1?a.floorId:null,s=Object.assign(Object.assign({},await q({floorsData:this.floorsData,meshBounds:this.meshBounds,client:i},t,o)),{floorId:o,roomId:null,sweepId:a.platformId});return[...e,s]}async addDefurnishEntries(e){var t;const i=null===(t=this.layersData.getDefurnishView())||void 0===t?void 0:t.id,n=i?this.snapshotsModule.snapshotsData.getSortedCollection().filter((e=>e.sourceViewId===i)):null;if(!(null==n?void 0:n.length))return e;const a=[],o=new Set;for(const t of e){a.push(t);if(t.snapshot.metadata.cameraMode===u.N3.Panorama&&t.roomId&&!o.has(t.roomId)&&this.roomBoundData.getRoom(t.roomId).classifications.some((e=>Z.includes(e.id)))){const e=n.find((e=>(0,Q.Lt)(e,t.snapshot)));e&&(a.push(Object.assign(Object.assign({},t),{id:(0,v.hA)(),sourceViewId:e.sourceViewId,snapshot:e,overrides:Object.assign(Object.assign({},t.overrides),{showRoomMeasurements:!0})})),o.add(t.roomId||""))}}return a}}const X=e=>{if(!e||!e.length)return!0;return e.filter((e=>!!e.description)).length/e.length<.5};class J{async generateTour(e){const{modelId:t,client:i}=e;await G({modelId:t,client:i});const n=await N({modelId:t,viewType:"matterport.user.insights",client:i}),a=new y.P(g.UR.REEL);return a.reel.replace(n),a}}var ee=i(12378),te=i(53631),ie=i(24790),ne=i(86426),ae=function(e,t,i,n){var a,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var r=e.length-1;r>=0;r--)(a=e[r])&&(s=(o<3?a(s):o>3?a(t,i,s):a(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},oe=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},se=function(e,t){return function(i,n){t(i,n,e)}};let re=class extends a.n{constructor({data:e},t,{data:i},{data:n},{policyData:a},{data:o},s,r,{data:l},d,{toolsData:u},m,{layersData:h},f){super(),this.name="tours-generator",this.templates=new Map,this.applicationData=e,this.cameraStartModule=t,this.floorsData=i,this.modelData=n,this.roomBoundData=o,this.settingsModule=s,this.snapshotsModule=r,this.sweepData=l,this.toursDataModule=m,this.toolsData=u,this.toolAnnouncementModule=d,this.layersData=h,this.visibleMeshBoundsModule=f,this.enabled=(0,p.W)(a,s.settingsData),c.Ay.for(this).info("AUTO TOURS ENABLED")}async init(e,t){const{baseUrl:i}=e;this.engine=t,this.client=(0,te.H)({baseUrl:i,server:ie.wD})(),this.registerTemplates(),this.registerSettings();const n=this.settingsModule.tryGetProperty(d.pH,!1);if(this.applicationData.application===o.lg.SHOWCASE&&n){const e=this.settingsModule.tryGetProperty(d.Ye,d.lB);await this.generateTourFromTemplate(e,{modelId:this.modelData.model.baseModelId,client:this.client}),this.announceAutoGenTourCreated()}else this.enabled&&this.announceAutoGenTourReady()}async generateTourFromTemplate(e,t){if(!this.enabled)throw new Error("Tour generation is not enabled");const i=this.templates.get(e);if(!i)throw new Error(`Template ${e} not found`);this.toolAnnouncementModule.setToolAnnouncementState(m.Q7.HLR_AUTOGEN_TOUR_READY,m.zR.CLOSE),this.toursDataModule.toggleAutoSave(!1),this.lastHighlightReel=this.toursDataModule.tourData.getReel().clone();try{this.engine.broadcast(new ee.r);const e=await i.generateTour(Object.assign({includeDefurnish:this.settingsModule.tryGetProperty(d.cD,d.JK),panAngle:this.settingsModule.tryGetProperty(d.nz,d.C0),panSpeed:this.settingsModule.tryGetProperty(d.Vq,d.au),regenerateText:this.settingsModule.tryGetProperty(d.H$,d.OU)},t));return e.reel.forEach((e=>{if(!e.snapshot.metadata.scanId&&e.snapshot.metadata.cameraPosition){const t=this.sweepData.getClosestSweep(e.snapshot.metadata.cameraPosition,!0);t&&(e.snapshot.metadata.scanId=t.id)}"dollhouse"===e.snapshot.name&&(e.snapshot.metadata.cameraMode=u.N3.Dollhouse,e.snapshot.metadata.scanId=void 0)})),this.replaceActiveReel(e),e}catch(e){throw this.discardGeneratedTour(),e}finally{this.engine.broadcast(new ee.i)}}announceAutoGenTourCreated(){const e=this.engine.subscribe(s.Fj,(({application:t})=>{t===o.lg.WORKSHOP&&(this.toolAnnouncementModule.setToolAnnouncementState(m.Q7.HLR_AUTOGEN_TOUR_CREATED,m.zR.OPEN),e.cancel())})),t=this.toolsData.onPropertyChanged("activeToolName",(()=>{this.toolAnnouncementModule.setToolAnnouncementState(m.Q7.HLR_AUTOGEN_TOUR_CREATED,m.zR.CLOSE),t.cancel()}))}announceAutoGenTourReady(){this.toolAnnouncementModule.setToolAnnouncementState(m.Q7.HLR_AUTOGEN_TOUR_READY,m.zR.OPEN)}replaceActiveReel(e){this.toursDataModule.setHighlightReel(e)}registerTemplates(){this.templates.size>0||(this.templates.set(h.p.SCOUT,new Y({cameraStartModule:this.cameraStartModule,floorsData:this.floorsData,roomBoundData:this.roomBoundData,snapshotsModule:this.snapshotsModule,sweepData:this.sweepData,layersData:this.layersData,meshBounds:this.visibleMeshBoundsModule})),this.templates.set(h.p.VISION,new J))}async acceptGeneratedTour(){const e=this.layersData.getBaseModelId(),t=this.toursDataModule.tourData.getReel(),i=await this.copyHlrToView(t,e);return this.replaceActiveReel(i),this.toursDataModule.toggleAutoSave(!0),!0}async discardGeneratedTour(){return this.lastHighlightReel&&this.replaceActiveReel(this.lastHighlightReel),this.toursDataModule.toggleAutoSave(!0),!0}async copyHlrToView(e,t){const i=c.Ay.for(this),n=e.clone();for(const e of n.reel){const n=e.snapshot.clone();if(n.category=j.X.TOUR,!n.imageBlob){const t=await e.snapshot.downloadUrl.get(),i=z(t,Object.assign(Object.assign({},d.hd),{fit:"crop"}));n.imageBlob=await(await fetch(i)).blob()}i.debug(`Uploading snapshot ${e.snapshot.sid} -> ${n.sid} on ${t}`);const a=await this.engine.commandBinder.issueCommand(new ne.Ns(n));a.sourceViewId=n.sourceViewId,e.snapshot=a,e.id=a.sid}return n}registerSettings(){const e="Tours";this.settingsModule.registerMenuEntry({header:e,urlParam:!0,setting:d.Ye,options:[...this.templates.keys()],initialValue:()=>d.lB}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,setting:d.pH,initialValue:()=>!1}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,range:[1,360],rangePrecision:0,setting:d.nz,initialValue:()=>d.C0}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,range:[1,20],rangePrecision:0,setting:d.Vq,initialValue:()=>d.au}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,setting:d.H$,initialValue:()=>d.OU}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,setting:d.cD,initialValue:()=>d.JK})}};re=ae([(0,n._q)(),se(0,(0,n.y_)(r.WJ)),se(1,(0,n.y_)(l.di)),se(2,(0,n.y_)(l.HX)),se(3,(0,n.y_)(l.bj)),se(4,(0,n.y_)(l.Uu)),se(5,(0,n.y_)(l.Vu)),se(6,(0,n.y_)(r.ZF)),se(7,(0,n.y_)(l.Pn)),se(8,(0,n.y_)(l.Wh)),se(9,(0,n.y_)(l.uq)),se(10,(0,n.y_)(l.N7)),se(11,(0,n.y_)(l.XQ)),se(12,(0,n.y_)(l.az)),se(13,(0,n.y_)(l.UN)),oe("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object])],re)},12378:(e,t,i)=>{"use strict";i.d(t,{i:()=>o,r:()=>a});var n=i(89103);class a extends n.QB{constructor(){super()}}class o extends n.QB{constructor(){super()}}}}]);