"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[9504],{25434:(i,t,n)=>{n.d(t,{Z:()=>o,u:()=>a});var e=n(89103);class a extends e.QB{constructor(i,t,n){super(),this.name=i,this.version=t,this.loadTime=n}}class o{constructor(){this.handlers=[{msgType:a,func:(i,t,n)=>{i.track("plugin_loaded",{name:t.name,version:t.version,time:t.loadTime})}}]}}},41122:(i,t,n)=>{n.d(t,{My:()=>r,W:()=>d,YB:()=>o,ho:()=>a,nq:()=>s,u3:()=>l});var e=n(55141);class a extends e.u{constructor(i,t=!1){super(),this.payload={exclude:i||[],hard:t}}}a.id="PLUGIN_RESET_ALL";class o extends e.u{constructor(i,t,n,e){super(),this.payload={name:i,config:t,configMeta:n,permissions:e||{}}}}o.id="PLUGIN_RELOAD";class s extends e.u{constructor(i,t,n,e){super(),this.payload={name:i,config:t,configMeta:n,permissions:e||{}}}}s.id="PLUGIN_LOAD";class l extends e.u{constructor(i){super(),this.payload={name:i}}}l.id="PLUGIN_UNLOAD";class r extends e.u{constructor(i,t){super(),this.payload={operation:i,callback:t}}}r.id="PLUGIN_CONFIG_FETCH_DATA";class d extends e.u{constructor(i,t){super(),this.payload={attachmentId:i,pluginId:t}}}d.id="ATTACHMENT_ASSOCIATE_WITH_PLUGIN";class c extends e.u{constructor(i,t){super(),this.payload={attachmentId:i,pluginId:t}}}c.id="ATTACHMENT_DISSOCIATE_FROM_PLUGIN"},69504:(i,t,n)=>{n.r(t),n.d(t,{PluginPermissionLevel:()=>a,default:()=>P});var e,a,o=n(90082),s=n(71687),l=n(30877),r=n(75578),d=n(73397),c=n(32948),u=n(56846),h=n(41122),p=n(25434);!function(i){i[i.FetchAnonymous=1]="FetchAnonymous",i[i.FetchAsUser=2]="FetchAsUser",i[i.AnyFetch=3]="AnyFetch",i[i.LocalData=4]="LocalData",i[i.EarlyLoad=268435456]="EarlyLoad",i[i.DisableSES=2147483648]="DisableSES"}(e||(e={})),function(i){i[i.Locked=0]="Locked",i[i.Default=4]="Default",i[i.DefaultEarlyLoad=268435462]="DefaultEarlyLoad",i[i.Fetch=6]="Fetch",i[i.FetchEarlyLoad=268435462]="FetchEarlyLoad",i[i.OpenEnvironment=4294967295]="OpenEnvironment"}(a||(a={}));var g=n(27947),f=n(25316),y=n(10843),m=n(79070),v=n(22585);class w{getFactory(i){return i.messengerFactory}}class P extends r.n{constructor(){super(...arguments),this.name="plugin",this.data=new c.C,this.allowLoad=!1,this.allowLiveReload=!0,this.applicationType=void 0,this.onResetPlugins=async({exclude:i,hard:t})=>{t&&await this.pluginConfigDataModule.reloadStoreData(!0),await this.unloadPlugins(i),await this.loadConfigured(i)},this.onLoadPlugin=async({config:i,configMeta:t,permissions:n},e)=>{var a;if(this.allowLiveReload&&e){const o={properties:t,required:[]};for(const i of Object.keys(o.properties)){(null===(a=o.properties[i].required)||void 0===a?void 0:a.includes(i))&&o.required.push(i)}if(!this.jsonSchemaValidator.validate(o,i))return;const s={applicationKey:e.applicationKey,id:e.id};if(this.data.get(s))return;await this.load(Object.assign(Object.assign(Object.assign({},e),{config:i}),n))}},this.onUnloadPlugin=async i=>{if(this.allowLiveReload&&i){const t={applicationKey:i.applicationKey,id:i.id};await this.unload(t)}},this.onReloadPlugin=async({name:i,config:t,configMeta:n,permissions:e},a)=>{this.allowLiveReload&&(await this.onUnloadPlugin(a),this.debouncedOnLoadPlugin({name:i,config:t,configMeta:n,permissions:e},a))},this.debouncedOnReloadPlugin=(0,m.s)(this.onReloadPlugin,100),this.onReloadPluginCommand=async i=>{if(!this.allowLiveReload)return;let t=this.configuredPlugins.find((t=>t.id===i.name));t||(t=this.createLoadableConfig(i.name)),this.debouncedOnReloadPlugin(i,t)},this.debouncedOnLoadPlugin=(0,m.s)(this.onLoadPlugin,100),this.onLoadPluginCommand=async i=>{this.debouncedOnLoadPlugin(i,this.createLoadableConfig(i.name))},this.debouncedOnUnloadPlugin=(0,m.s)(this.onUnloadPlugin,100),this.onUnloadPluginCommand=async i=>{let t=this.configuredPlugins.find((t=>t.id===i.name));if(!t){const n=this.availablePlugins.get(i.name);n&&(t={applicationKey:n.applicationKey,id:n.name})}this.debouncedOnUnloadPlugin(t)},this.onFetchSdkDataCommand=async i=>{const t=await this.engine.diContainer.resolve("$ServiceSdk");try{const{sdkEndpoint:n,path:e}=await this.resolveSdkEndpoint(t,i.operation);let a;a="function"==typeof n?await this.resolvePath(await n(),e):await this.handleSubscription(n,e),i.callback(a)}catch(t){throw new Error(`Failed to run command: ${i.operation}\n${null==t?void 0:t.message}`)}}}async init(i,t){if(this.jsonSchemaValidator=i.jsonSchemaValidator,[this.ses,this.sdk,this.pluginConfigDataModule,this.pluginUIData,this.settings,this.applicationData]=await Promise.all([t.getModuleBySymbol(s.JY),t.getModuleBySymbol(o.S1),t.getModuleBySymbol(s.lf),t.market.waitForData(d.kR),t.market.waitForData(f.o),t.market.waitForData(g.zH)]),this.separator=this.pluginUIData.separator,this.engine=t,this.allowLoad=i.pluginPolicies.enabled,this.allowLiveReload=this.allowLoad&&!this.pluginConfigDataModule.pluginConfigData.disabled&&!this.pluginConfigDataModule.pluginConfigData.preventLiveEdit,this.allowLoad&&(this.initializeServiceConnection()?await this.loadConfigured([],!0):y.Ay.for(this).error("Plugins Disabled: Failed to connect service SDK")),this.allowLoad){const i=t.subscribe(v.uv,(async({phase:n,application:e})=>{if(n===g.Jj.PLAYING)if(i.cancel(),this.applicationType=e,this.allowLiveReload){if(await this.loadConfigured(),!this.settings.getOverrideParam(u.L$,!1))if(this.applicationData.getName()===g.lg.WORKSHOP)await this.loadEditOnly();else{const n=t.subscribe(v.Fj,(async t=>{y.Ay.for(this).devInfo("Switch in active application detected by plugin system: ",t.application),t.application===g.lg.WORKSHOP&&(await this.loadEditOnly(),i.cancel())}));this.bindings.push(n)}}else y.Ay.for(this).devInfo("Reached PLAYING stage, checking whether configured plugins need to load to start: ",e),e===g.lg.SHOWCASE&&await this.loadConfigured(),this.bindings.push(t.subscribe(v.Fj,(async i=>{if(y.Ay.for(this).devInfo("Switch in active application detected by plugin system: ",i.application),i.application===g.lg.WORKSHOP)try{await this.disposeAll()}catch(i){y.Ay.for(this).debugWarn("Entering workshop, one or more plugins failed to dispose properly:",i)}else i.application===g.lg.SHOWCASE&&await this.loadConfigured()})))}))}this.bindings.push(t.commandBinder.addBinding(h.ho,this.onResetPlugins),t.commandBinder.addBinding(h.YB,this.onReloadPluginCommand),t.commandBinder.addBinding(h.nq,this.onLoadPluginCommand),t.commandBinder.addBinding(h.u3,this.onUnloadPluginCommand),t.commandBinder.addBinding(h.My,this.onFetchSdkDataCommand)),t.market.register(c.C,this.data)}initializeServiceConnection(){try{const i=this.pluginConfigDataModule.serviceSdkKey;this.engine.diContainer.bindAsyncFactory("$ServiceSdk",(()=>l.p.connect({connect:()=>this.sdk.connectPlugin(i,"PluginConfigRootConnection"),cancelConnecting:()=>{}},new w,window)))}catch(i){return y.Ay.for(this).error(i),!1}return!0}broadcastLoadEvent(i){this.engine.broadcast(new p.u(i.id,i.src,Date.now()-performance.timing.navigationStart))}async loadEditOnly(){var i,t;this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins;const n=this.availablePlugins.values.filter((i=>{var t;return null===(t=i.options)||void 0===t?void 0:t.editOnly}));if(n.length>0){const e=n.map((i=>i.name));y.Ay.for(this).debug("Loading editOnly plugins: "+e.join(", "));const a=[];for(const e of n){const n={id:e.name,src:e.src,config:e.config,outputs:e.outputs,applicationKey:e.applicationKey,strict:e.strict,peerDependencies:e.peerDependencies,permissionLevel:e.fetchLevel,canPlaceInGrid:null===(i=e.options)||void 0===i?void 0:i.canPlaceInGrid,hideViewToggle:!1!==(null===(t=e.options)||void 0===t?void 0:t.hideViewToggle)};a.push(this.load(n).then((()=>{this.broadcastLoadEvent(n)})))}await Promise.all(a)}}async loadConfigured(i=[],t=!1){if(!this.pluginConfigDataModule.pluginConfigData.disabled)return this.pluginConfigDataModule.registryLoaded?void await this.updatePluginDataAndLoad(i,t):new Promise((n=>{this.registrySubscription=this.pluginConfigDataModule.registryLoadedObservable.onChanged((async e=>{e&&(await this.updatePluginDataAndLoad(i,t),n())}))}));y.Ay.for(this).debug("Cannot load plugins! Disabled by URL parameter.")}async updatePluginDataAndLoad(i,t){this.configuredPlugins=await this.pluginConfigDataModule.getConfiguredPlugins(this.applicationType,t),this.availablePlugins=this.pluginConfigDataModule.pluginConfigData.availablePlugins,y.Ay.for(this).debug("Combined configuration with registry data, loading plugins: "+JSON.stringify(this.configuredPlugins,void 0,2)),await this.waitForPluginLoad(i)}async waitForPluginLoad(i){if(!this.configuredPlugins)return void y.Ay.for(this).error("Waiting for load before plugin records fetched.");const t=[];for(const i of this.configuredPlugins){const n={applicationKey:i.applicationKey,id:i.id};this.data.get(n)||t.push(this.load(i).then((()=>{this.broadcastLoadEvent(i)})))}try{await Promise.all(t)}catch(i){y.Ay.for(this).warn("Issues were encountered loading configured plugins.")}this.pluginUIData.restoreAllVisibility(i)}async fetchPlugin(i,t,n,e,a){e.strict&&this.ses.freezeForStrict();const o=await this.ses.makeSecureEnvironment(i+`${n?this.separator+n:""}`,t,e,this.pluginConfigDataModule.pluginConfigData.eventTarget,a);if(await(null==o?void 0:o.initialEvaluation()),o){return[o,o.compartment.globalThis.plugin]}return null}async unload(i){const t=i.id&&""!==i.id?i.id:"default",n={applicationKey:i.applicationKey,id:t},e=this.data.get(n);let a=null;if(e){try{a=e.dispose()}catch(i){y.Ay.for(this).warn("An error occurred when disposing a plugin, it may be in a partially disposed state",i)}this.data.delete(n)}return a||Promise.resolve()}async load(i){var t;const{applicationKey:n,src:o,id:s,strict:l,permissionLevel:r=a.Default,peerDependencies:d,canPlaceInGrid:c}=i;if(!this.allowLoad){const i=o.startsWith("http")?o:`${o.substring(0,16)}...`;return Promise.reject(`Load for plugin <${s}:${i}> requested, but plugin system is not available.`)}if(n.includes(this.separator))return Promise.reject(`Application Key cannot contain the separator character: ${this.separator}`);if(s.includes(this.separator))return Promise.reject(`Plugin ID cannot contain the separator character: ${this.separator}`);const u=void 0===l||l,h=s||"default",p={applicationKey:n,id:h};if(this.data.get(p))return Promise.reject(`Plugin for ${n}-${h} already loaded.`);const g={strict:u,canFetch:!!(r&e.AnyFetch),canFetchAsUser:!!(r&e.FetchAsUser),canStoreLocal:!0,canPlaceInGrid:c||!1,shadowRootMode:"closed",isFullyOpen:!!(r&e.DisableSES)},[f,y]=await this.fetchPlugin(n,o,h,g,d)||[];if(f&&y){const n=null===(t=f.overlayElement)||void 0===t?void 0:t.querySelector(`.${s}`);n&&!i.hideViewToggle&&this.pluginUIData.initVisibilityData(h,n,i),await this.initPlugin(f,y.factory,i,h)}}async initPlugin(i,t,n,e){const a=t(),{applicationKey:o,id:s,config:r}=n;let d=()=>{};const c=a.onInit||a.init;let u=Promise.resolve();if(c){class i{constructor(i){this.sdk=i}connect(){return this.sdk.connectPlugin(o,s)}cancelConnecting(){}}const t=await l.p.connect(new i(this.sdk),new w,window);u=c.call(a,t,r),d=()=>t.disconnect()}const h=this.pluginConfigDataModule.pluginConfigData.eventTarget,p=this.pluginUIData.setupVisibilityEvents(h);async function g(){const t=a.onDestroy||a.dispose;return((null==t?void 0:t.call(a))||Promise.resolve()).finally((()=>{d(),p.cancel(),h.delete(e),i.dispose()}))}const f={applicationKey:o,id:s};try{return await u,this.data.set(f,a,g),Promise.resolve()}catch(i){y.Ay.for(this).warn(`Plugin initialization failed for ${s} `,i),y.Ay.for(this).debugWarn("Attemptying dispose for clean up...");try{await g()}catch(i){y.Ay.for(this).warn("Auto-cleanup of plugin had errors: ",i)}return Promise.reject(i)}}dispose(i){super.dispose(i),this.registrySubscription.cancel(),this.disposeAll().catch((i=>{y.Ay.for(this).warn("One or more plugins failed to dispose properly.",i)}))}disposeAll(){return this.configuredPlugins=[],this.unloadPlugins()}unloadPlugins(i=[]){y.Ay.for(this).devInfo("Unloading all plugins...except: "+i.join(", "));const t=[];for(const[n,e]of this.data.plugins.entries()){const a=n.split(".")[1];i.includes(a)||(t.push(e.dispose()),this.data.plugins.delete(n)),this.pluginUIData.pluginIdSet.delete(n)}return Promise.all(t)}createLoadableConfig(i){var t,n;const e=this.availablePlugins.get(i),{src:a,config:o,applicationKey:s,strict:l,outputs:r,peerDependencies:d}=e;return{id:i,src:a,config:o,outputs:r,applicationKey:s,strict:l,peerDependencies:d,permissionLevel:e.fetchLevel,canPlaceInGrid:null===(t=e.options)||void 0===t?void 0:t.canPlaceInGrid,hideViewToggle:null===(n=e.options)||void 0===n?void 0:n.hideViewToggle}}async resolveSdkEndpoint(i,t){const[n,...e]=t.split(":"),a=n.split(".");let o="";const s=a.reduce(((i,t)=>(o=t,null==i?void 0:i[t])),i);if(!s)throw new Error(`Invalid SDK namespace or endpoint for ${t} at ${o}`);return{sdkEndpoint:s,path:e}}async handleSubscription(i,t){return new Promise(((n,e)=>{const a=i.subscribe((i=>{a.cancel();try{const e=this.resolvePath(i,t);n(e)}catch(i){e(i)}}))}))}resolvePath(i,t){for(let n=0;n<t.length;n++){const e=t[n],a="object"!=typeof i&&null!==i,o=n!==t.length-1;if(a)throw new Error(`Invalid path: ${t.join(".")} - can't index ${e} into non-object`);if(!i.hasOwnProperty(e)){if(o)throw new Error(`Invalid path: ${t.join(".")} - key "${e}" not found`);return y.Ay.for(this).debugWarn(`Invalid path: ${t.join(".")} - key "${e}" not found`),"--KeyError--"}i=i[e]}return i}}},30877:(i,t,n)=>{n.d(t,{p:()=>e});var e,a=n(50505);!function(i){const t=new a.o;i.connect=async function(i,n,e){let a;try{a=await i.connect()}finally{i.cancelConnecting()}return function(i,t,n,e){return new t(n,i).build(e)}(e,await async function(i){if(!i)throw new Error("Unabled to load the sdk");try{const n=await t.load(i,"sdk-client");if(n&&n.SdkBuilder&&"function"==typeof n.SdkBuilder)return n.SdkBuilder}catch(i){}throw Error(`Could not load the sdk from ${i}`)}(a.scriptUrl),n.getFactory(a),a.serializedInterface)}}(e||(e={}))}}]);