"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[3745],{50857:(e,t,i)=>{i.r(t),i.d(t,{NavigationVisuals:()=>S,debugSweepScoring:()=>P,default:()=>x,visDollhouseNavigation:()=>M,visPanoNavigation:()=>v});var o=i(90082),s=i(71687),n=i(82240),a=i(86866),r=i(52026),c=i(65882),h=i(20599),l=i(5243),u=i(62372),p=i(99583),d=i(25316),g=i(22299),m=i(81662),w=i(83075),y=i(23987),f=i(48539);const b={howManySweepScoresToShow:0};class S{constructor(e,t,i){this.engine=e,this.dynamicNumber=t,this.smoothWalk=i,this.active=!1,this.draw=new n.U,Promise.all([this.engine.getModuleBySymbol(s.M7),this.engine.market.waitForData(l.$),this.engine.getModuleBySymbol(s.PM),this.engine.market.waitForData(d.o),this.engine.getModuleBySymbol(o.ZF),this.engine.getModuleBySymbol(s.Kv)]).then((([e,t,i,o,s,n])=>{var a;this.meshQuery=i,this.draw.setStyle({assetBasePath:null!==(a=o.getProperty("assetBasePath"))&&void 0!==a?a:""}),this.draw.addToScene(e.getScene()),this.subscription=t.onChanged((()=>this.update(this.draw,t))),this.subscription.cancel();const r="Navigation";[{header:r,setting:"navDebugEnabled",initialValue:()=>!1,onChange:e=>this.toggle(e),urlParam:!0},{header:`${r}-Scoring`,setting:"navScoring",initialValue:()=>0,range:[0,20],rangePrecision:0,onChange:e=>{b.howManySweepScoresToShow=e},urlParam:!0},{header:`${r}-Filtering`,setting:"raycastNeighbors",initialValue:()=>n.config.raycastNeighbors,onChange:e=>{n.config.raycastNeighbors=e},urlParam:!0},{header:`${r}-Filtering`,setting:"maxDistSameFloor",initialValue:()=>c.U.maxDistSameFloor,range:[3,50],rangePrecision:0,onChange:e=>c.U.maxDistSameFloor=e,urlParam:!0},{header:`${r}-Filtering`,setting:"maxDistOtherFloors",initialValue:()=>c.U.maxDistOtherFloors,range:[3,50],rangePrecision:1,onChange:e=>c.U.maxDistOtherFloors=e,urlParam:!0},{header:`${r}-Filtering`,setting:"directionFactor",initialValue:()=>c.U.directionFactor,range:[-1,1],rangePrecision:2,onChange:e=>c.U.directionFactor=e,urlParam:!0},{header:`${r}-Scoring`,setting:"dirWeight",initialValue:()=>c.U.directionWeight,range:[-5,10],rangePrecision:1,onChange:e=>c.U.directionWeight=e,urlParam:!0},{header:`${r}-Filtering`,setting:"viewDirFactor",initialValue:()=>c.U.viewDirectionFactor,range:[-1,1],rangePrecision:2,onChange:e=>c.U.viewDirectionFactor=e,urlParam:!0},{header:`${r}-Scoring`,setting:"viewDirWeight",initialValue:()=>c.U.viewDirectionWeight,range:[-5,10],rangePrecision:1,onChange:e=>c.U.viewDirectionWeight=e,urlParam:!0},{header:r,setting:"accel",initialValue:()=>this.dynamicNumber.acceleration,range:[1,60],rangePrecision:.5,onChange:e=>{this.dynamicNumber.setAccel(e)}},{header:r,setting:"top speed",initialValue:()=>this.dynamicNumber.maxSpeed,range:[1,40],rangePrecision:.5,onChange:e=>this.dynamicNumber.setMaxSpeed(e)},{header:r,setting:"queue ms",initialValue:()=>this.smoothWalk.repeatedQueueDelayMS,range:[0,1e3],onChange:e=>this.smoothWalk.repeatedQueueDelayMS=e}].forEach((e=>s.registerMenuEntry(e)))}))}toggle(e){this.active!==e&&(e||this.draw.toggleAll(!1),e||this.subscription.cancel(),e&&this.subscription.renew(),!e&&C&&(y.Z.clear(),C=!1),this.active=e)}update(e,t){const i=this.engine.market.tryGetData(u.A),o=this.engine.market.tryGetData(h.M),n=this.engine.market.tryGetData(p.X),a=this.engine.market.tryGetData(g.J);if(e&&i&&o&&n&&a&&(e.toggleAll(!1),t.hit&&this.meshQuery.floorIdFromObject(t.hit.object)))if(n.isInside()){const n=this.engine.getModuleBySymbolSync(s.sA),r=this.engine.getModuleBySymbolSync(s.Kv);v(e,i,o,t.hit.intersection,this.meshQuery,a,n,r)}else M(e,i,t.hit.intersection,this.meshQuery)}}const v=(e,t,i,o,s,n,c,h)=>{let l=0;const u=o.point.clone();if(0===n.opacity.value&&c){const t=c.picking.pick(i.pose.position,i.pose.forward(),w.m2.isRoomMesh);t&&(u.copy(t.point),e.sphere("panosphere"+l,{color:"red",opacity:.4}).toggle(!0).update(u,.1))}const p=u.clone().sub(i.pose.position),d=[],g=[],y=(0,r.GI)({sweepData:t,direction:p,meshQuery:(null==h?void 0:h.config.raycastNeighbors)?s:void 0,viewDirection:(null==h?void 0:h.config.raycastNeighbors)?i.pose.forward():void 0,ignoreSweeps:[],scorers:d,filters:g}),f=Math.max(...y.map((e=>e.score))),b=f-5;P(y,d,g);for(const{sweep:t,score:i}of y)if(t){const o=0===l?"cyan":"orange",s=(0,a.m9)(i,b,f,0,.6);e.line("panosphere"+l++,o).toggle(!0).updatePositions(u,t.position).opacity(s);const n=(0,a.m9)(s,0,.6,.002,.1);if(e.sphere("panosphere"+l++,{color:o,opacity:.8}).toggle(!0).update(t.position,n),t.sourceViewId){const i=(0,a.$i)(t.position,m.B1.UP,n+n+.05);e.line("panosphere"+l++,"yellow").toggle(!0).updatePositions(t.position,i).opacity(s),e.sphere("panosphere"+l++,{color:o,opacity:.8}).toggle(!0).update(i,n)}}},M=(e,t,i,o)=>{let s=0;const n=[],c=[],h=(0,r.I9)(t,!1,i,o,n,c);P(h,n,c);const l=Math.max(...h.map((e=>e.score))),u=l-15;for(const{sweep:t,score:o}of h)if(t){const n=0===s?"cyan":"orange",r=(0,a.m9)(o,u,l,0,1);e.line("panosphere"+s++,n).toggle(!0).updatePositions(i.point,t.position).opacity(r);const c=(0,a.m9)(r,0,1,.05,.3);e.sphere("panosphere"+s++,{color:n}).toggle(!0).update(t.position,c)}};let C=!1;function P(e,t,i,o=b.howManySweepScoresToShow){if(o>0){C=!0,y.Z.clear(),y.Z.logValue("candidate sweeps after filtering",e.length),y.Z.logValue("raycasts checked during filtering",r.vM.count),y.Z.logValue("filters:",i.map((e=>e.name)).join(", "));let s=0;for(const{sweep:i,score:n}of e)i&&++s<=o&&(y.Z.logValue(`rank: ${s}, sweep.index: ${(0,f.Ho)(i.index+1,3)}, platformId`,i.platformId),t.forEach(((e,t)=>{y.Z.logValue(`rank: ${s}, score${e.name}${t}`,e(i).toFixed(4))})),y.Z.logValue(`rank: ${s}, using ${t.length} scorers, total`,n.toFixed(4)))}else C&&(C=!1,y.Z.clear())}function x(e){e.getModuleBySymbol(s.Kv).then((t=>{const i=t.navigationWalk,o=i.positionTracker;new S(e,o,i)}))}},46317:(e,t,i)=>{i.r(t),i.d(t,{default:()=>h});var o=i(84440),s=i(10843),n=i(90082),a=i(71687);const r=new s.Ay("raycaster-debug");class c{constructor(e){Promise.all([e.getModuleBySymbol(n.ZF),e.getModuleBySymbol(a.M7),e.getModuleBySymbol(a.sA)]).then((([e,t,i])=>{const s=t.getScene(),n=[];let a=!1;const c=()=>{n&&n.forEach((e=>{e.geometry.dispose(),e.material.dispose(),s.remove(e)}))},h=(e,t,a)=>{r.info("draw",{from:e,to:t,faces:a});const c=i.getOctree().getDebugBoundsMesh((0,o.Mq)().getHex(),e,t,a);c.frustumCulled=!1,c.updateMatrixWorld(!0),s.add(c),n.push(c)};e.registerMenuButton({header:"Raycaster",buttonName:"Add Octree Level Buttons",callback:()=>{if(!a){for(let t=0;t<=i.getOctree().depth;t++)e.registerMenuButton({header:"Octree Levels",buttonName:`Anything on Level: ${t}`,callback:()=>{c(),h(t,t,!1)}});for(let t=0;t<=i.getOctree().depth;t++)e.registerMenuButton({header:"Octree Faces",buttonName:`Faces on Level: ${t}`,callback:()=>{c(),h(t,t,!0)}});a=!0}}}),e.registerMenuButton({header:"Raycaster",buttonName:"Visualize Octree - All",callback:()=>{c();for(let e=0;e<=i.getOctree().depth;e++)h(e,e,!1)}}),e.registerMenuButton({header:"Raycaster",buttonName:"Visualize Octree - Faces",callback:()=>{c();for(let e=0;e<=i.getOctree().depth;e++)h(e,e,!0)}}),e.registerMenuButton({header:"Raycaster",buttonName:"Clear Octree Visuals",callback:c})}))}}function h(e){new c(e)}},12655:(e,t,i)=>{i.r(t),i.d(t,{default:()=>f});var o=i(90082),s=i(71687),n=i(68909),a=i(82240),r=i(86866),c=i(30443),h=i(81662),l=i(20599),u=i(5243),p=i(3694),d=i(38069);const g=new(i(10843).Ay)("raycaster-debug");var m;!function(e){e.normal="normal",e.hitClass="hitClass",e.hitBounds="hitBounds"}(m||(m={}));const w={color:"yellow"};class y{get draw(){return this._draw||(this._draw=new a.U({background:!1,color:d.V.RED.clone()}),this.engine.getModuleBySymbol(s.M7).then((e=>this._draw.addToScene(e.getScene())))),this._draw}constructor(e){this.engine=e,this.cached={v1:new n.Vector3,v2:new n.Vector3,quat:new n.Quaternion},this.showClass=!1,this.showName=!0,this.showNormal=!1,this.showBounds=!1,this.drawRaycastHitNormal=e=>{const t=this.draw.line(m.normal,"red",4);e&&t.updatePositions(e.point,this.cached.v1.copy(e.point).addScaledVector(e.normal,.2)),t.toggle(null!==e)},this.drawRaycastObjectInfo=(e,t,i,o)=>{const s=this.draw.label(m.hitClass,"X",this.cached.v1,1);if(s.visible=!1,e&&t&&(i||o)){const{position:n,rotation:a}=t.pose,{point:c,object:l}=e,u=i?l.__proto__.constructor.name:"",p=o?""!==l.name?l.name:l.id:"";s.text=`${u} - ${p}`,s.setPosition(c,(e=>t.isOrtho()?e.addScaledVector(h.B1.UP,10):(0,r.jS)(n,e,1,e))),s.scaleBillboard(n,a,t.pose.projection,t.zoom(),t.height,t.aspect(),.1),s.setOrientation(a),s.visible=!0}},this.drawRaycastHitBounds=e=>{const t=this.draw.boxWire(m.hitBounds,w).toggle(!1);if(e&&e.object&&!(e.object instanceof p.W)&&e.object instanceof n.Mesh){const i=(0,c.UX)(e.object.geometry),o=i.getCenter(this.cached.v1).applyMatrix4(e.object.matrixWorld),s=i.getSize(this.cached.v2).multiply(e.object.scale).multiplyScalar(.5);t.mesh.quaternion.copy(e.object.quaternion),t.toggle(!0).update(o,s)}},this.onPointerDown=()=>{const e=this.data.hit;e&&e.object&&g.warn(e.object,e)},Promise.all([e.getModuleBySymbol(o.ZF),e.market.waitForData(u.$)]).then((([e,t])=>{this.data=t;const i=t.onChanged((()=>this.update(t)));i.cancel();const o=e=>{e?(window.addEventListener("pointerdown",this.onPointerDown),i.renew()):(window.removeEventListener("pointerdown",this.onPointerDown),i.cancel(),this.draw.toggleAll(!1))};e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitDebugging",initialValue:()=>!1,onChange:e=>{o(e)},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitClass",initialValue:()=>this.showClass,onChange:e=>{this.showClass=e},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitName",initialValue:()=>this.showName,onChange:e=>{this.showName=e},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitNormal",initialValue:()=>this.showNormal,onChange:e=>{this.showNormal=e},urlParam:!0}),e.registerMenuEntry({header:"Raycaster",setting:"raycasterHitBounds",initialValue:()=>this.showBounds,onChange:e=>{this.showBounds=e},urlParam:!0})}))}update(e){const t=this.engine.market.tryGetData(l.M);this.showNormal&&this.drawRaycastHitNormal(e.hit),this.showBounds&&this.drawRaycastHitBounds(e.hit),this.drawRaycastObjectInfo(e.hit,t,this.showClass,this.showName)}}function f(e){new y(e)}},9831:(e,t,i)=>{i.r(t),i.d(t,{default:()=>u});var o=i(90082),s=i(71687),n=i(68909),a=i(52947),r=i(43543),c=i(32484);const{TILEDMESH_SETTINGS:h}=c.yJ,l="Snapping";async function u(e){const[t,i,c]=await Promise.all([e.getModuleBySymbol(o.ZF),await e.getModuleBySymbol(s.sA),e.getModuleBySymbol(s.M7)]),u=i.snapping,p=c.getScene().scene;t.registerMenuEntry({header:l,setting:"snappingMaxLOD",initialValue:()=>h.snappingMaxLOD,onChange:e=>{h.snappingMaxLOD=e},urlParam:!0,rangePrecision:0,range:[0,3]}),function(e,t,i){const o=new n.BufferGeometry,s=new n.LineSegments(o,new n.LineBasicMaterial({vertexColors:!0}));s.frustumCulled=!1;const r=new n.SphereGeometry(.02,5,5);let c;const h=[16711680,65280,255,16777215],u=new n.Color,p=(new n.Matrix4).identity(),d=new n.Group;let g;function m(){const e=[],i=[],l=[],g=[];t.forEachSnapFeature((t=>{var o,s,n;if(u.setHex(h[(null===(n=null===(s=null===(o=t.meta)||void 0===o?void 0:o.tile)||void 0===s?void 0:s.extras)||void 0===n?void 0:n.level)||0]),t instanceof a.cF){const{start:o,end:s}=t;e.push(o.x,o.y,o.z,s.x,s.y,s.z),i.push(u.r,u.g,u.b,u.r,u.g,u.b)}else t instanceof a.F7&&(l.push(t.x,t.y,t.z),g.push(u.r,u.g,u.b))}),!0),o.dispose(),o.setAttribute("position",new n.Float32BufferAttribute(e,3)),o.setAttribute("color",new n.Float32BufferAttribute(i,3)),c&&3*c.count===l.length||(c&&(d.remove(c),null==c||c.dispose()),c=new n.InstancedMesh(r,new n.MeshBasicMaterial,l.length/3));for(let e=0;e<l.length;e+=3)c.setMatrixAt(e/3,p.setPosition(l[e],l[e+1],l[e+2])),c.setColorAt(e/3,u.setRGB(g[e],g[e+1],g[e+2]));d.add(s,c)}e.registerMenuEntry({header:l,setting:"Show Snapping Features",initialValue:()=>!1,onChange(e){e?(i.add(d),g=setInterval(m,300)):(null==c||c.dispose(),r.dispose(),o.dispose(),i.remove(d),clearInterval(g))}})}(t,u,p),function(e,t,i,o){const s=[];let a,c;function h(){c||(c=new n.Mesh(new n.BufferGeometry,new n.MeshBasicMaterial({vertexColors:!0})),c.frustumCulled=!1,i.add(c));const e=[],t=[];for(const i of s){let o=0;for(const s of i.surfaces){const i=s.area>.1,n=Math.sin(o++)/2+.5,a=i?0:.2+.8*n,r=i?.2+.8*n:0,c=0;for(const i of s.faces){const o=i.va.vector,s=i.vb.vector,n=i.vc.vector;e.push(o.x,o.y,o.z),e.push(s.x,s.y,s.z),e.push(n.x,n.y,n.z),t.push(a,r,c,a,r,c,a,r,c)}}}c.geometry.dispose(),c.geometry.setAttribute("position",new n.Float32BufferAttribute(e,3)),c.geometry.setAttribute("color",new n.Float32BufferAttribute(t,3))}function u(e){s.push(e.edgeFinder)}[{header:l,setting:"Collect Snapping Surfaces",initialValue:()=>!1,onChange(e){e?o.subscribe(r.X,u):(o.unsubscribe(r.X,u),s.length=0)}},{header:"Snapping",setting:"Show Snapping Surfaces",initialValue:()=>!1,onChange(e){clearInterval(a),e?a=setInterval((()=>{t.preloadMeshSnapping(),h()}),1e3):c&&(c.geometry.dispose(),i.remove(c),c=null)}}].forEach((t=>e.registerMenuEntry(t)))}(t,u,p,e)}},2942:(e,t,i)=>{i.r(t),i.d(t,{PanoPreloadVisualizer:()=>S,default:()=>v});var o=i(10843),s=i(90082),n=i(71687),a=i(82240),r=i(23870),c=i(20599),h=i(5243),l=i(62372),u=i(99583),p=i(50018),d=i(68909),g=i(81662),m=i(9997),w=i(40397),y=i(13893),f=i(38069);const b=new o.Ay("previs");class S{constructor(e,t,i){this.engine=e,this.downloadDescriptorGetter=t,this.prioritizer=i,this.allPreloadedSweeps=new Set,this.active=!1,this.freezeCameraRotation=!1,this.sweepIndex=50,this.useCurrentCriteria=!0,this.showPreloadIds=!0,this.visualTour=!1,this.showSweepLabels=!1,this.draw=new a.U,this.engine.getModuleBySymbol(n.M7).then((e=>this.draw.addToScene(e.getScene()))),this.engine.market.waitForData(h.$).then((e=>{this.subscription=e.onChanged((()=>this.update(this.draw))),this.subscription.cancel()}));const o=this.engine.market.tryGetData(l.A);if(o){this.sweepData=o;const e=o.getSweepList(),t=new r.A((e=>e.id));for(let i of e)i.isObservableProxy&&(i=new p.Ay({platformId:i.platformId}).copy(i)),t.add(i);this.sweepMap=t}this.engine.getModuleBySymbol(s.ZF).then((e=>{const t="Pano Preload",i=[{header:t,setting:"ShowVis",initialValue:()=>this.active,onChange:e=>this.toggle(e)},{header:t,setting:"Use Camera",initialValue:()=>this.useCurrentCriteria,onChange:e=>{this.useCurrentCriteria=e,this.update(this.draw)}},{header:t,setting:"Freeze Rotation",initialValue:()=>this.freezeCameraRotation,onChange:e=>{this.freezeCameraRotation=e,this.update(this.draw)}},{header:t,setting:"Show preload ids",initialValue:()=>this.showPreloadIds,onChange:e=>{this.showPreloadIds=e,this.update(this.draw)}},{header:t,setting:"Visual tour",initialValue:()=>this.visualTour,onChange:e=>{this.visualTour=e,this.update(this.draw)}},{header:t,setting:"Pano labels",initialValue:()=>this.showSweepLabels,onChange:e=>{this.showSweepLabels=e,this.update(this.draw)}},{header:t,setting:"Override Sweep",initialValue:()=>0,onChange:e=>this.updateSweepIndex(e),range:[0,this.sweepMap.count()]}];e.registerMenuButton({header:"Pano Preload tour",buttonName:"Tour",callback:()=>{this.activateTourMode()}}),i.forEach((t=>e.registerMenuEntry(t)))}))}updateSweepIndex(e){const t=Math.round(e);this.sweepIndex=t,this.update(this.draw)}toggle(e){this.active!==e&&(e&&this.subscription.renew(),e||(this.subscription.cancel(),this.draw.toggleAll(!1)),this.active=e)}update(e){const t=this.engine.market.tryGetData(l.A),i=this.engine.market.tryGetData(c.M),o=this.engine.market.tryGetData(u.X);if(!(e&&t&&i&&o))return;if(!this.active||!this.sweepMap)return;if(this.tourMode&&!this.visualTour)return;const s=t.getSweepList(),n=this.useCurrentCriteria?this.prioritizer.priorityCriteria:this.criteria;if(this.useCurrentCriteria){if(this.freezeCameraRotation){if(!n.sweep)return;n.set({position:n.sweep.position,rotation:this.lastCriteria.rotation,direction:g.B1.FORWARD.clone().applyQuaternion(this.lastCriteria.rotation)})}}else if(n.set({sweep:this.sweepData.getSweepByIndex(this.sweepIndex)||null}),!this.freezeCameraRotation){if(!n.sweep)return;n.set({position:n.sweep.position,rotation:i.pose.rotation,direction:g.B1.FORWARD.clone().applyQuaternion(i.pose.rotation)})}if(this.lastCriteria=n.clone(),!n.sweep)return;this.tourMode||this.wipePreloadedData();const a=[];this.prioritizer.priorityCriteria=n,this.prioritizer.filterAndPrioritize(a,this.downloadDescriptorGetter);const r=new Set;let h="";for(const e of a)e&&e.sweep&&(r.has(e.sweep.id)||(r.add(e.sweep.id),h+=`${e.sweep.index}, `),this.allPreloadedSweeps.has(e.sweep.id)||this.allPreloadedSweeps.add(e.sweep.id));const p=new d.Vector3(0,0,-1.5).applyQuaternion(i.pose.rotation),m=(new d.Vector3).copy(i.pose.position).add(p),w=`Current Pano: ${n.sweep.index}\n    ${this.showPreloadIds?`Panos: ${h}`:""}\n    Preload Count (this pano): ${r.size}\n    Total Preloaded: ${this.allPreloadedSweeps.size}`,y=e.label("infoLabel",w,m,.1);if(y.lookAt(i.pose.position),y.setPosition(m),y.text=w,this.drawSweepSpheres(r,n),this.showSweepLabels)for(const t of s){const o=`${t.index}`,s=e.label(t.id,o,t.position,.1);s.text=o,s.setColor(f.V.RED),s.lookAt(i.pose.position)}}drawSweepSpheres(e,t){const i=t.sweep;if(!i)return;this.draw.toggleAll(!1);const o=(new d.Vector3).copy(i.position);o.y+=-.5;for(const t of e){const e=this.sweepData.getSweep(t),s=i===e,n=s?"green":"white",a=(new d.Vector3).copy(e.position);if(a.y+=-.5,this.draw.sphere(e.id+"sphere"+(s&&"source"),{color:n,opacity:1}).update(a,.2).toggle(!0),!s){const t=this.draw.line(`${e.id}-${i.id}`,new d.Color("white"),.05);t.updatePositions(a,o),t.toggle(!0)}}}activateTourMode(){this.tourMode=!0;const e={},t=Math.round(this.sweepIndex),i=this.sweepData.getSweepByIndex(t);i&&this.engine.commandBinder.issueCommand(new m.aj({sweep:i.id})).then((()=>{this.wipePreloadedData(),this.allPreloadedSweeps.clear();const t=this.sweepData.getSweepList(),o=Math.round(.05*t.length);i&&this.tourStep(i,e,o)}))}tourStep(e,t,i,o=0,s=""){const n=e,a=this.sweepData.getSweepList();let r=e;if(!n||n.neighbours.length<=0)return;t[n.id]=!0,s+=`Sweep: ${n.index} Loaded: ${this.allPreloadedSweeps.size}\n`;let c=0;for(;c<a.length;){const e=(n.index+1+c)%a.length,i=this.sweepData.getSweepByIndex(e);if(c++,i&&(r=i,!t[r.id]&&r.id!==n.id&&r))break}if(++o<=i)if(this.visualTour)this.engine.commandBinder.issueCommand(new m.aj({sweep:n.id,rotation:(0,w.kf)(n.position,r.position),transition:y.fl.Interpolate})).then((()=>{setTimeout((()=>{this.tourStep(r,t,i,o,s)}),500)}));else{const e=(0,w.kf)(n.position,r.position),a=(new d.Vector3).copy(g.B1.FORWARD).applyQuaternion(e),c=this.prioritizer.priorityCriteria.clone();c.set({direction:a,rotation:e,sweep:n,position:n.position});const h=[];this.prioritizer.priorityCriteria=c,this.prioritizer.filterAndPrioritize(h,this.downloadDescriptorGetter);this.queueToPanoSet(h).forEach((e=>this.allPreloadedSweeps.add(e))),this.tourStep(r,t,i,o,s)}else b.info(`TOUR END\n      Sweeps visited: ${o}\n      Visual: ${this.visualTour}\n      Sweeps preloaded: ${this.allPreloadedSweeps.size}`),b.info(`TOUR INFO\n      ${s}`),this.tourMode=!1}queueToPanoSet(e){const t=new Set;for(const i of e)i&&i.sweep&&(t.has(i.sweep.id)||t.add(i.sweep.id));return t}wipePreloadedData(){const e=this.sweepData.getSweepList();for(const t of e)this.downloadDescriptorGetter.deleteAllTileDownloadDescriptors(t.id)}}function v(e){e.getModuleBySymbol(n.qD).then((t=>{const i=t;"tileDownloader"in i&&new S(e,i.tileDownloader,i.tilePrioritizer)}))}},17158:(e,t,i)=>{i.r(t),i.d(t,{default:()=>P});var o=i(90082),s=i(25316),n=i(71687),a=i(21875),r=i(68909),c=i(95183),h=i(54387),l=i(79728),u=i(53172),p=i(1333),d=i(2993),g=i(99583),m=i(20599),w=i(41819),y=i(13893),f=i(88664),b=i(37458);var S=i(28165),v=i(47737),M=i(53631),C=i(24790);async function P(e){const[t,i,s]=await Promise.all([e.getModuleBySymbol(o.ZF),e.getModuleBySymbol(n.Gw),e.market.waitForData(v.P)]),a="Tours";t.registerMenuButton({header:a,buttonName:"Generate a tour",callback:async()=>{const e=(0,M.H)({baseUrl:window.location.origin,server:C.wD})(),o=t.tryGetProperty(S.Ye,S.lB),n=s.getBaseModelId();i.generateTourFromTemplate(o,{modelId:n,client:e})}});const r=new x(e);await r.init(),t.registerMenuEntry({header:a,setting:"visualizeTourStops",initialValue:()=>!1,urlParam:!0,onChange:e=>{r[e?"activate":"deactivate"]()}})}class x{constructor(e){this.engine=e,this.active=!1,this.root=new r.Group,this.rebuild=()=>{this.root.traverse((e=>{(0,h.uW)(e)&&e.geometry.dispose()})),this.root.clear(),this.active&&(this.localTourData.enabledTourStops.forEach((e=>{const t=this.localTourData.getTourIndexBySid(e),i=this.localTourData.getTourEntry(e);if(!i)return;const{cameraPosition:o,cameraMode:s,cameraQuaternion:n,scanId:a}=i.snapshot.metadata,c=function(e,t=.8,i=.6){const o=e/5.7%1;return(new r.Color).setHSL(o,t,i)}(t);t>0&&this.renderTravelPath(i,t,c),this.localCameraData.pose.position.copy(o),this.localCameraData.pose.rotation.copy(n),this.localViewmodeData.currentMode=s,this.localTourData.setTourCurrentSnapshotByIndex(t),this.localSweepData.currentSweep=a,this.renderStopLocation(i,t,c),s===d.N3.Panorama&&this.renderPanAngle(i,t,c)})),this.localTourData.setTourCurrentSnapshotByIndex(0),this.scene.add(this.root))}}async init(){const[e,t,i,o]=await Promise.all([this.engine.market.waitForData(s.o),this.engine.market.waitForData(a.R),this.engine.getModuleBySymbol(n.Wh),this.engine.getModuleBySymbol(n.M7)]);this.scene=o.getScene(),this.settingsData=e,this.localTourData=Object.create(t),this.localSweepData=Object.create(i.data);const r=Object.create(i,{data:{value:this.localSweepData}});this.localCameraData=new m.M(1,1),this.localViewmodeData=new g.X,this.transitionFactory=new l.A(this.engine,this.localTourData,r,this.localCameraData,e,this.localViewmodeData),await this.transitionFactory.init(),t.onChanged(this.rebuild),this.root.name="tours-debug",this.root.renderOrder=b.X.gizmos}renderStopLocation(e,t,i){const o=new r.Mesh(new r.SphereGeometry(.25),new r.MeshBasicMaterial({color:i,opacity:.8,depthTest:!1}));o.add(new D(t)),o.position.copy(e.snapshot.metadata.cameraPosition),this.root.add(o)}renderPanAngle(e,t,i){const o=this.transitionFactory.getBurnsTransition(t);o instanceof w.H&&this.root.add(new B(e,o,i))}renderTravelPath(e,t,i){var o,s;const n=null!==(s=null===(o=e.overrides)||void 0===o?void 0:o.transitionType)&&void 0!==s?s:this.settingsData.tryGetProperty(f.zk,y.fl.Interpolate),a=this.transitionFactory.getMainTransition(t,n);a instanceof p.Tz&&this.root.add(new V(a,i))}activate(){this.active||(this.active=!0,this.rebuild())}deactivate(){this.active&&(this.active=!1,this.rebuild())}}class B extends r.Mesh{constructor(e,t,i){var o,s;const n=new r.CircleGeometry(1.5,16,(0,u.pu)(90),(0,u.pu)(t.degrees*(t.direction===p.ND.Left?1:-1)));n.rotateX((0,u.pu)(-90));super(n,new r.MeshBasicMaterial({color:i,side:r.DoubleSide,transparent:!0,opacity:.5,depthTest:!1})),this.position.copy((null===(o=t.startPose)||void 0===o?void 0:o.position)||e.snapshot.metadata.cameraPosition),this.quaternion.copy((null===(s=t.startPose)||void 0===s?void 0:s.rotation)||e.snapshot.metadata.cameraQuaternion)}}class D extends c.EY{constructor(e){super(),this.text=`${e+1}`,this.fontSize=.35,this.outlineWidth=.01,this.anchorX="center",this.anchorY="middle",this.material=new r.MeshBasicMaterial({depthTest:!1}),this.renderOrder=b.X.gizmos+.1}onBeforeRender(e,t,i,o,s,n){super.onBeforeRender(e,t,i,o,s,n),this.quaternion.copy(i.quaternion)}}class V extends r.InstancedMesh{constructor(e,t){const i=e.calculateCurve(),o=Math.round(i.totalLength/.15),s=[];for(let e=0;e<o;e++)s.push(i.curve.getPoint(e/(o-1)));super(new r.SphereGeometry(.05),new r.MeshBasicMaterial({color:t,transparent:!0,opacity:.8,depthTest:!1}),s.length+e.sweeps.length);const n=new r.Matrix4;s.forEach(((e,t)=>{this.setMatrixAt(t,n.makeTranslation(e))})),e.sweeps.forEach((({position:e},t)=>{this.setMatrixAt(s.length+t,n.makeScale(2,2,2).setPosition(e))}))}}},33796:(e,t,i)=>{i.r(t),i.d(t,{default:()=>n});var o=i(90082),s=i(71687);async function n(e){const[t,i]=await Promise.all([e.getModuleBySymbol(o.ZF),e.getModuleBySymbol(s.M7)]),n="WebGL Renderer";let a=null;function r(e){i.threeRenderer.forceContextLoss(),setTimeout((()=>{i.threeRenderer.forceContextRestore()}),e)}t.registerMenuButton({header:n,buttonName:"Lose Context for 0.1 sec",callback:()=>{r(100)}}),t.registerMenuButton({header:n,buttonName:"Lose Context for 5 sec",callback:()=>{r(5e3)}}),t.registerMenuEntry({header:n,setting:"autoLoseContext",initialValue:()=>!1,urlParam:!0,onChange(e){if(e){const e=()=>r(100);e(),a=setInterval(e,1e4)}else clearInterval(a)}})}},82240:(e,t,i)=>{i.d(t,{U:()=>M});var o=i(81662),s=i(68909);class n{constructor(e,t,i){return this.thisType=e,this.container=t,this.mesh=i(),this.mesh.name=`${e.name}`,this.material=this.mesh.material,this.geometry=this.mesh.geometry,this}opacity(e){return this.material.opacity=e,this}}function a(e,t){t.forEach((t=>{Object.getOwnPropertyNames(t.prototype).forEach((i=>{e.prototype[i]=t.prototype[i]}))}))}class r{constructor(){this.animationInit=!1}initAnimationMixin(e,t){this.animState={scale:t?t.clone():new s.Vector3(1,1,1),position:e?e.clone():new s.Vector3,target:{scale:t?t.clone():new s.Vector3(1,1,1),position:e?e.clone():new s.Vector3},temp:{pos:new s.Vector3,scale:new s.Vector3,makeScale:new s.Vector3}},this.animationInit=!0}update(e,t){if(!this.animationInit)throw Error(`${r.name} call this.initAnimationMixin() in ${this.style} constructor to enable update, because I said so.`);this.mesh.position.copy(e);const i=this.vector3From(t);return i.equals(this.mesh.scale)||this.mesh.scale.copy(i),this.animState.scale.copy(this.mesh.scale),this.animState.position.copy(this.mesh.position),this.mesh.updateMatrixWorld(!0),this}animate(e,t,i){if(!this.animationInit)throw Error(`${r.name} call this.initAnimationMixin() in ${this.style} constructor to enable animations, because I said so.`);const o=this.vector3From(i);this.animState.target.scale.copy(o),this.animState.target.position.copy(t);const s=this.animState.temp.pos.copy(this.mesh.position).lerp(t,e),n=this.animState.temp.scale.copy(this.mesh.scale).lerp(o,e);return this.update(s,n),this}vector3From(e){if(e instanceof s.Vector3)return this.animState.temp.makeScale.copy(e).clamp(h,l);if("number"==typeof e)return this.animState.temp.makeScale.set(e,e,e).clamp(h,l);throw Error("Unexpected scale input")}}const c=.01,h=new s.Vector3(c,c,c),l=new s.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);class u{toggle(e){return e?this.container.add(this.mesh):this.container.remove(this.mesh),this.isVisible=e,this}}class p extends n{constructor(e,t){super(p,e,(()=>new s.Mesh(new s.BoxGeometry(1,1,1),new s.MeshBasicMaterial(t)))),this.container=e,this.style="Box",this.mesh.frustumCulled=!1,this.geometry.computeBoundingBox(),this.initAnimationMixin()}}a(p,[r,u]);class d extends n{constructor(e,t){super(d,e,(()=>{const e=new s.Box3Helper((new s.Box3).setFromCenterAndSize(new s.Vector3,new s.Vector3(1,1,1)));return new s.LineSegments(e.geometry,e.material)})),this.container=e,this.style="BoxWireframeMesh",t&&this.material.setValues(t),this.mesh.frustumCulled=!1,this.initAnimationMixin()}}a(d,[u,r]);class g extends n{constructor(e,t){super(g,e,(()=>new s.CameraHelper(t))),this.container=e,this.style="CameraHelper",this.updateCamera(t)}updateCamera(e){return this.mesh.camera.copy(this.camWithSaneFarDistance(e)),this.mesh.update(),this}camWithSaneFarDistance(e){const t=e.clone();return t.far=5,t}}a(g,[u]);class m extends n{constructor(e,t){super(m,e,(()=>new s.Mesh(new s.PlaneGeometry(1),new s.MeshBasicMaterial(t)))),this.container=e,this.style="PlaneMesh",this.radius=1;const i=new s.Matrix4;i.makeRotationFromEuler(new s.Euler(-Math.PI/2,0,0,"XYZ")),this.geometry.applyMatrix4(i),this.mesh.frustumCulled=!1,this.initAnimationMixin()}}a(m,[u,r]);class w extends n{constructor(e,t){super(w,e,(()=>new s.Mesh(new s.SphereGeometry(1),new s.MeshBasicMaterial(t)))),this.container=e,this.style="SphereMesh",this.radius=1,this.mesh.frustumCulled=!1,this.initAnimationMixin()}}a(w,[u,r]);var y=i(38069);class f extends n{constructor(e,t){return super(f,e,(()=>new s.Line(new s.BufferGeometry,new s.LineBasicMaterial(Object.assign({color:y.V.MP_BRAND,opacity:1,transparent:!0},t))))),this.container=e,this.positionsBuffer=new s.BufferAttribute(new Float32Array(150),3),this.point=new s.Vector3,this.points={start:new s.Vector3,control:new s.Vector3,end:new s.Vector3},this.updatePoints=(e,t,i)=>{this.points.start.copy(this.curve.v0.copy(e)),this.points.control.copy(this.curve.v1.copy(t)),this.points.end.copy(this.curve.v2.copy(i));for(let e=0;e<50;e++){const t=e/49;this.curve.getPoint(t,this.point),this.positionsBuffer.setXYZ(e,this.point.x,this.point.y,this.point.z)}return this.positionsBuffer.needsUpdate=!0,this},this.animatePoints=(e,t,i,o)=>{const{start:s,control:n,end:a}=this.points;return s.equals(n)&&s.equals(a)?(this.updatePoints(t,i,o),this):(s.lerp(t,e),n.lerp(i,e),a.lerp(o,e),this.updatePoints(s,n,a),this)},this.mesh.frustumCulled=!1,this.curve=new s.QuadraticBezierCurve3(new s.Vector3,new s.Vector3,new s.Vector3),this.geometry.setAttribute("position",this.positionsBuffer),this.geometry.computeBoundingBox(),this}}a(f,[u]);var b=i(52514),S=i(40266),v=i(4679);class M{constructor(e,t={}){this.cache={},this.helperCache={},this.style={},this.toggle=e=>(this.options.scene&&(e?this.options.scene.add(this.options.container):this.options.scene.remove(this.options.container)),this),this.box=(e,t)=>(this.cache[x.box][e]||(this.cache[x.box][e]=new p(this.options.container,t).toggle(!0)),this.cache[x.box][e]),this.boxWire=(e,t)=>(this.cache[x.boxWire][e]||(this.cache[x.boxWire][e]=new d(this.options.container,t).toggle(!0)),this.cache[x.boxWire][e]),this.cam=(e,t)=>(this.cache[x.cameraHelper][e]||(this.cache[x.cameraHelper][e]=new g(this.options.container,t).toggle(!0)),this.cache[x.cameraHelper][e]),this.label=(e,t,i,o=.25)=>{if(!this.labelCreator){const{color:e,backgroundColor:t,backgroundOpacity:i,background:o}=this.options;this.labelCreator=new b.Il(Object.assign({color:e,background:o,backgroundColor:t,backgroundOpacity:i,wordWrapWidth:650},this.style))}if(!this.cache[x.label][e]){const s=this.labelCreator.createLabel();this.cache[x.label][e]=s,s.position.copy(i),s.text=t,s.scaleFactor=o,this.options.container.add(s)}return this.cache[x.label][e]},this.line=(e,t=this.options.lineColor,i=this.options.linewidth)=>{if(!this.cache[x.line][e]){const s=(0,S.makeLineMaterial)(t,!1,{linewidth:i}),n={onShow:()=>this.options.container.add(...a.children),onHide:()=>this.options.container.remove(...a.children)},a=new v.e(o.B1.ZERO.clone(),o.B1.ZERO.clone(),s,n);a.updateResolution(window.innerWidth,window.innerHeight).opacity(1).toggle(!0),this.cache[x.line][e]=a}return this.cache[x.line][e]},this.plane=(e,t)=>(this.cache[x.plane][e]||(this.cache[x.plane][e]=new m(this.options.container,t).toggle(!0)),this.cache[x.plane][e]),this.setStyle=e=>{this.style=e},this.sphere=(e,t)=>(this.cache[x.sphere][e]||(this.cache[x.sphere][e]=new w(this.options.container,t).toggle(!0)),this.cache[x.sphere][e]),this.triangle=(e,t,i,o,n)=>{if(!this.cache[x.triangle][e]){const a=new Float32Array(9);t.toArray(a,0),i.toArray(a,3),o.toArray(a,6);const r=new s.BufferGeometry;r.setAttribute("position",new s.BufferAttribute(a,3));const c=new s.Mesh(r,new s.MeshBasicMaterial(n));this.options.container.add(c),this.cache[x.triangle][e]=new w(this.options.container,n).toggle(!0)}return this.cache[x.triangle][e]},this.spline=(e,t)=>(this.cache[x.spline][e]||(this.cache[x.spline][e]=new f(this.options.container,t).toggle(!0)),this.cache[x.spline][e]),this.randomColor=e=>{if(void 0!==e){if(!this.helperCache[B.color][e]){const t=new s.Color(C(),C(),C());this.helperCache[B.color][e]=t}return this.helperCache[B.color][e]}return new s.Color(C(),C(),C())},this.randomVector3=e=>{if(void 0!==e){if(!this.helperCache[B.vector3][e]){const t=new s.Vector3(2*(.5-C()),2*(.5-C()),2*(.5-C()));this.helperCache[B.vector3][e]=t}return this.helperCache[B.vector3][e]}return new s.Vector3(2*(.5-C()),2*(.5-C()),2*(.5-C()))},this.toggleAll=e=>{for(const t of Object.values(x)){const i=Object.values(this.cache[t]);for(const t of i)"toggle"in t&&t.toggle(e)}return this},this.options=Object.assign(Object.assign({},P),e),this.style=t;for(const e of Object.values(x))this.cache[e]={};for(const e of Object.values(B))this.helperCache[e]={};this.options.scene&&this.toggle(!0)}async addToScene(e){return this.options.scene=e,this.toggle(!0),this}}const C=()=>Math.random(),P={lineColor:y.V.WHITE.clone(),linewidth:2,color:y.V.WHITE.clone(),background:!0,backgroundColor:y.V.WHITE.clone(),backgroundOpacity:.5,container:new s.Group};var x,B;!function(e){e.box="box",e.boxWire="boxWire",e.label="label",e.line="line",e.plane="plane",e.sphere="sphere",e.spline="spline",e.triangle="triangle",e.cameraHelper="cameraHelper"}(x||(x={})),function(e){e.color="color",e.vector3="vector3"}(B||(B={}))},83075:(e,t,i)=>{i.d(t,{PO:()=>s,m2:()=>n});var o=i(99276);const s=e=>!!e&&e instanceof o.B,n={hasMeshGroup:e=>"object"==typeof e&&!!e&&"meshGroup"in e,hasMeshSubgroup:e=>"object"==typeof e&&!!e&&"meshSubgroup"in e,isRoomMesh:s,isVisibleRoomMesh:e=>s(e)&&e.raycastEnabled&&e.visible}},52026:(e,t,i)=>{i.d(t,{GI:()=>d,I9:()=>g,IV:()=>p,VM:()=>u,Y7:()=>m,vM:()=>l});var o=i(78229),s=i(96659),n=i(65882);if(5602==i.j)var a=i(3066);if(5602==i.j)var r=i(9997);var c=i(40397),h=i(86866);const l={count:0};function u(e){return(0,a.Sh)((()=>e(new r.Jq)),(()=>e(new r.sD)),!1)}const p=e=>{const{additionalFilter:t,sweepData:i,direction:n,sourceSweep:a,ignoreSweeps:r,directionFactor:c}=e;if(!i.currentSweepObject)return[];const h=a||i.currentSweepObject,l=[o.AU(h),o.Ol(),o.xg(h),o.jW(h.position,n,c)];for(const e of r)l.push(o.AU(e));const u=[s.oW(h.position,n),s.Io(h.position)];t&&l.push(t);const p=i.getSweepNeighbours(h);return i.sortByScore(l,u,p)},d=e=>{const{sweepData:t,direction:i,viewDirection:a,sourceSweep:r,ignoreSweeps:c,directionFactor:h,additionalFilter:u,meshQuery:p,scorers:d=[],filters:g=[]}=e;if(!t.currentSweepObject)return[];const m=i.clone().normalize(),w=a?a.clone().normalize():void 0,f=r||t.currentSweepObject;g.push(o.AU(f),o.Ol(),o.fm(f.position,n.U.maxDistSameFloor*n.U.maxDistSameFloor),o.Zx());for(const e of c)g.push(o.AU(e));return p&&!f.neighborsEdited||g.push(o.xg(f)),w?g.push(b(f,m,w,null!=h?h:n.U.directionFactor,n.U.viewDirectionFactor)):g.push(o.jW(f.position,m,h)),u&&g.push(u),p&&!f.neighborsEdited&&g.push(S(f,p)),w&&d.push(s.VY(f.position,w,n.U.viewDirectionWeight)),d.push(s.oW(f.position,m,n.U.directionWeight),s.Io(f.position),v(f),y(f.sourceViewId)),l.count=0,t.sortByScore(g,d)},g=(e,t,i,a,r=[],c=[])=>{c.push(o.Ol(),o.Zx()),r.push(s.Io(i.point));const h=e.currentSweepObject;t&&h?(c.push(o.AU(h),o.lp(h.position,n.U.longerTransitionMaxDist),o.xg(h)),r.push(w(e),y(h.sourceViewId))):c.push(o.lp(i.point,n.U.longerTransitionMaxDist)),i.face&&c.push(o.DJ(i.point,i.face.normal));const u=a.floorIdFromObject(i.object);u&&c.push(o.Eo(u));const p=a.mdsRoomIdFromObject(i.object);p&&c.push(f(p)),l.count=0;const d=e.sortByScore(c,r);if(0===d.length){const t=e.getClosestSweep(i.point,!0);d.push({sweep:t,score:0})}return d},m=(e,t,i)=>{const o=(0,c.kf)(e,t);return i&&o.multiply(i),(0,h.V5)(o)},w=e=>{function t(t){return e.containsSweep(t.id)?5:-5}return Object.defineProperty(t,"name",{value:"_preferUnfiltered"}),t},y=e=>{function t(t){return e===t.sourceViewId?1:-1}return Object.defineProperty(t,"name",{value:"_bySameView"}),t},f=e=>{function t(t){return e===t.roomId}return Object.defineProperty(t,"name",{value:"_bySameRoom"}),t},b=(e,t,i,s,n)=>{const a=o.jW(e.position,t,s);Object.defineProperty(a,"name",{value:"_filterByDir"});const r=o.Zz.some(o.Zz.every(a,o.lp(e.position,5)),o.jW(e.position,i,n));Object.defineProperty(r,"name",{value:"_filterByDirOrViewDir"});return t.dot(i)<.25?a:r},S=(e,t)=>{function i(i){return l.count++,!t.isSegmentOccluded(e.position,i.position)}return Object.defineProperty(i,"name",{value:"_notRaycastNeighbors"}),i},v=e=>{function t(t){return o.xg(e)(t)?1:-1}return Object.defineProperty(t,"name",{value:"_visionNeighbors"}),t}},23870:(e,t,i)=>{i.d(t,{A:()=>s});const o=e=>""+e;class s{constructor(e=o){this.mappingFunction=e,this.list=[],this.map={}}add(e){const t=this.mappingFunction(e);return!this.map[t]&&(this.list.push(e),this.map[t]=e,!0)}set(e){const t=this.mappingFunction(e);return this.map[t]?(this.map[t]=e,!0):(this.add(e),!0)}count(){return this.list.length}*[Symbol.iterator](){for(const e of this.list)yield e}getByIndex(e){return this.list[e]}get(e){return this.map[e]}copyToList(e){return e.push(...this.list),e}clear(){this.list=[],this.map={}}mapElements(e){return this.list.map(e)}}},84440:(e,t,i)=>{i.d(t,{Mq:()=>r,Zd:()=>a,_o:()=>c});var o=i(68909);const s=()=>Math.random(),n={},a=(e,t=s())=>(n[t]||(n[t]=new o.Vector4(s(),s(),s(),e)),n[t]),r=()=>new o.Color(s(),s(),s()),c=e=>e instanceof Object&&"r"in e&&"g"in e&&"b"in e}}]);